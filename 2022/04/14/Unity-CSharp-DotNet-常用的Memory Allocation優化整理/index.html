<!DOCTYPE html>
<html lang="zh-tw" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="Game,Unity,Programming" />
  <meta name="author" content="PeDev" />
  <meta name="description" content="who is currently making a 2d platformer game." />
  
  
  <title>Unity/C#.Net 常用的 Memory Allocation 優化整理 | PE工具箱</title>

  
    <link rel="apple-touch-icon" href="/melody-favicon.ico">
    <link rel="icon" href="/melody-favicon.ico">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  
<link rel="stylesheet" href="/css/color-scheme.css">
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/iconfont/iconfont.css">
<link rel="stylesheet" href="/css/github-markdown.css">
<link rel="stylesheet" href="/css/highlight.css">
<link rel="stylesheet" href="/css/comments.css">
<link rel="stylesheet" href="/css/video-container.css">


  <!-- jquery3.3.1 -->
  <script src="/js/jquery.min.js"></script>

  <!-- fancybox -->
  <link href="/css/jquery.fancybox.min.css" rel="stylesheet">
  <script async src="/js/jquery.fancybox.min.js"></script>
  
<script src="/js/fancybox.js"></script>


  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
  <!-- prism.css -->
  <link rel="stylesheet" href="/js/prism/prism.css">
<meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="PE工具箱" type="application/atom+xml">
</head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img src="/images/profile/avatar.gif" alt="">
      
    </a>
    <div class="nickname"><a href="/">PeDev</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">About</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->

<!-- LaTex Display -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>
<script>
MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']]
  }
};
</script>



  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">Unity/C#.Net 常用的 Memory Allocation 優化整理</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime" title="Update time"></i>
          2022-04-14 07:24:00
        </span>
        
              <span class="post-tags">
                <i class="iconfont icon-tags" title="Tags"></i>
                
                <span class="span--tag">
                  <a href="/tags/Unity/" title="Unity">
                    <b>#</b> Unity
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/C/" title="C#">
                    <b>#</b> C#
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <h1 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h1>
<p>正式 full-tim e開發目前這個 2D 遊戲專案前後也有快 2 年半左右，前前後後時常在優化性能，這篇文想單純整理一下我優化記憶體來盡量達成Zero Allocation 的方式。</p>
<h1 id="zero-allocation"><a class="markdownIt-Anchor" href="#zero-allocation"></a> Zero Allocation</h1>
<p>Zero Allocation 嚴格定義是指不做任何 dynamic/heap memory allocation，不過在 Unity/C#.Net 這裡我會比較喜歡解釋成「不做任何重複的heap allocation」，所以使用 object pooling 時第一次必要的 allocation 可以被接受，之後要二次使用時會從 pool 中拿回之前使用過的 memory 以避免第二次 allocate。</p>
<h1 id="why"><a class="markdownIt-Anchor" href="#why"></a> Why?</h1>
<p>首先 memory allocation 本身算是一個大開銷，再者 C# 語言有 Garbage Collection 這個大坑，GC 讓你不需要也沒辦法主動釋放你申請使用的 heap memory，更會無預警的執行 <code>GC.Collect()</code> 導致那個瞬間的遊戲畫面卡頓。</p>
<blockquote>
<p>可能有人會說你可以主動執行 <code>GC.Collect()</code> 來主動釋放記憶體，但執行這個方法的代價很高，它會掃一遍所有的記憶體來尋找 unused，這個搜尋行為本身就貴到不能隨便使用了。</p>
</blockquote>
<p>所以優化方向當然是盡可能地減少 memory allocation ，並大幅地重複利用它們。</p>
<p>特別是Unity的那些 <code>Update</code> , <code>FixedUpdate</code>, <code>LateUpdate</code> 等幾乎每個frame都會執行的方法絕對要是Zero Allocation，這算是我自己對專案的最基本優化要求。</p>
<p><em>因為我們的環境是在 unity 底下，所以以下我會直接把 Heap Memory Allocation 稱為 <strong>GC.Alloc</strong></em>，這是在 Unity Profiler 中使用的名詞，也方便我們直接觀察。</p>
<span id="more"></span>
<h1 id="when-is-heap-memory-allocated"><a class="markdownIt-Anchor" href="#when-is-heap-memory-allocated"></a> When is heap memory allocated?</h1>
<p>首先我們要知道哪些行為會導致GC.Alloc，其實就是: <strong>實例化一個類別(class)物件</strong>。</p>
<p>最直接的方法就是用<code>new</code>關鍵字:<code>Class a = new Class();</code>，這樣就會發生allocation。要注意只有class/reference type才會GC.Alloc，而struct/value type就不會有。<br />
所以要了解這件事你要先理解struct和class的實質差別在哪裡，我之前有一篇文有講到這個: <a href="/2020/12/14/More-Effective-C-2nd-%E8%AE%80%E6%9B%B8%E7%AD%86%E8%A8%98/#%E5%8D%80%E5%88%86%E5%AF%A6%E5%80%BCvalue%E8%88%87%E5%8F%83%E8%80%83reference%E5%9E%8B%E5%88%A5">More-Effective-C-2nd-讀書筆記</a>。</p>
<p>其他比較間接的方法之所以會產生GC.Alloc都是它們方法內部有偷偷幫你做了這個動作但你不知道而已，反正最後在Unity Profiler都可以很清楚地發現問題。</p>
<p>總之我接下來會整理一些我自己很常見的案例以及改善方法，以下的順序和出現頻率無關，單純只是我撰寫的時候想到什麼就寫什麼。</p>
<h1 id="cases"><a class="markdownIt-Anchor" href="#cases"></a> Cases</h1>
<h2 id="1-能用struct就不要用class"><a class="markdownIt-Anchor" href="#1-能用struct就不要用class"></a> 1. 能用struct就不要用class</h2>
<p>new class是最直接的發生原因，而有些人會濫用class，即使它明明該是個value type的結構也通通寫成class，如下面案例。</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Transform2DValue</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token class-name">Vector2</span> position<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">float</span></span> rotation<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Vector2</span> scale<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">Transform2DValue</span><span class="token punctuation">(</span><span class="token class-name">Transform</span> transform<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>position <span class="token operator">=</span> transform<span class="token punctuation">.</span>position<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rotation <span class="token operator">=</span> transform<span class="token punctuation">.</span>eulerAngles<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>scale <span class="token operator">=</span> transform<span class="token punctuation">.</span>localScale<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Apply</span><span class="token punctuation">(</span><span class="token class-name">Transform</span> destination<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        destination<span class="token punctuation">.</span>position <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>position<span class="token punctuation">;</span>
        destination<span class="token punctuation">.</span>eulerAngles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rotation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        destination<span class="token punctuation">.</span>localScale <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scale<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CopyTransformTo</span><span class="token punctuation">(</span><span class="token class-name">Transform</span> source<span class="token punctuation">,</span> <span class="token class-name">Transform<span class="token punctuation">[</span><span class="token punctuation">]</span></span> destinations<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Transform2DValue</span> transformValue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Transform2DValue</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// GC.Alloc!</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> item <span class="token keyword">in</span> destinations<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        transformValue<span class="token punctuation">.</span><span class="token function">Apply</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>這個案例的<code>Transform2DValue</code>是用來儲存2D物件的transform資訊的值，之後可以把這個值Apply到傳入參數的目標上來達成複製transform的功能。</p>
<h3 id="solution"><a class="markdownIt-Anchor" href="#solution"></a> Solution</h3>
<p>很顯然這個方法會因為new而造成GC.Alloc，但我們其實根本不需要把<code>Transform2DValue</code>定義成class阿。首先它本來就是拿來做為Value儲存使用，那它應該是Value Type才符合定義，改成struct就解決了。</p>
<p>而且struct在各種使用上<strong>通常</strong>都會比class有效率，除非你是一個成員欄位龐大或需要長期使用的型別，否則大多時候能用struct就用，特別是案例這種僅在method scope內暫時使用的local variable。</p>
<p>延伸: <a target="_blank" rel="noopener" href="https://mdfarragher.medium.com/whats-faster-in-c-a-struct-or-a-class-99e4761a7b76">What Is Faster In C#: A Struct Or A Class?</a></p>
<h2 id="2-non-constant-string"><a class="markdownIt-Anchor" href="#2-non-constant-string"></a> 2. Non-constant string</h2>
<p>string是一個特殊基礎型別，它是一個盡量實作成Value Type的Reference Type Class，一般的Assign operator不會有問題，但一些需要copy/new操作的方法就幾乎避免不了GC.Alloc，最常見的是<code>string.Concat</code>或以<code>operator+</code>表示<code>stringA + stringB</code>操作，以及任何object都有的<code>ToString()</code>方法。</p>
<blockquote>
<p>這邊有特別強調是Non-constant string，因為constant string會從一個內部的pool申請出來，兩個constant string的reference是一樣的，這點你可以用<code>ReferenceEquals()</code>方法來驗證。</p>
</blockquote>
<p>這邊舉幾個例子:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Process</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    Profiler<span class="token punctuation">.</span><span class="token function">BeginSample</span><span class="token punctuation">(</span><span class="token string">"Constant strings"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// These cases are allocation-free.</span>
    <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">string</span></span> constant <span class="token operator">=</span> <span class="token string">"constant"</span><span class="token punctuation">;</span>
    <span class="token function">StringParameter</span><span class="token punctuation">(</span><span class="token string">"constant"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">StringParameter</span><span class="token punctuation">(</span>constant<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">string</span></span> constantStringConcat <span class="token operator">=</span> <span class="token string">"string"</span> <span class="token operator">+</span> <span class="token string">"concat"</span><span class="token punctuation">;</span> <span class="token comment">// Compiler optimize it as "stringconcat" directly.</span>
    <span class="token class-name"><span class="token keyword">string</span></span> constantStringConcat2 <span class="token operator">=</span> <span class="token string">"string"</span> <span class="token operator">+</span> constant<span class="token punctuation">;</span> <span class="token comment">// Compiler optimize it as "stringconcat" directly.</span>
    Profiler<span class="token punctuation">.</span><span class="token function">EndSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Profiler<span class="token punctuation">.</span><span class="token function">BeginSample</span><span class="token punctuation">(</span><span class="token string">"Non-constant string concat"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">string</span></span> nonConstant <span class="token operator">=</span> <span class="token string">"nonConstant"</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">string</span></span> nonConstantConcat <span class="token operator">=</span> <span class="token string">"string"</span> <span class="token operator">+</span> nonConstant<span class="token punctuation">;</span> <span class="token comment">// GC.Alloc</span>
    Profiler<span class="token punctuation">.</span><span class="token function">EndSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Profiler<span class="token punctuation">.</span><span class="token function">BeginSample</span><span class="token punctuation">(</span><span class="token string">"string.Concat"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">string</span></span> stringConcat <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Concat</span><span class="token punctuation">(</span><span class="token string">"string"</span><span class="token punctuation">,</span> <span class="token string">"concat"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// GC.Alloc</span>
    Profiler<span class="token punctuation">.</span><span class="token function">EndSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Profiler<span class="token punctuation">.</span><span class="token function">BeginSample</span><span class="token punctuation">(</span><span class="token string">"MethodConcat"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">string</span></span> methodConcat <span class="token operator">=</span> <span class="token function">MethodConcat</span><span class="token punctuation">(</span><span class="token string">"string"</span><span class="token punctuation">,</span> <span class="token string">"concat"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// GC.Alloc</span>
    Profiler<span class="token punctuation">.</span><span class="token function">EndSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Profiler<span class="token punctuation">.</span><span class="token function">BeginSample</span><span class="token punctuation">(</span><span class="token string">"int.ToString()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">string</span></span> intString <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// GC.Alloc</span>
    Profiler<span class="token punctuation">.</span><span class="token function">EndSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">StringParameter</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> nonConstant<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">MethodConcat</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> lhs<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> rhs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> lhs <span class="token operator">+</span> rhs<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>打開Profiler驗證無誤:<br />
<img src="https://i.imgur.com/30u0Cpn.png" alt="" /></p>
<h3 id="solution-2"><a class="markdownIt-Anchor" href="#solution-2"></a> Solution</h3>
<p>string其實還挺無解的，平常就盡量避免使用，某些情形可以改用<code>enum</code>取代。不過最終還是一定有需要用string的地方，這時候我就只能推這個大神寫的library了: <a target="_blank" rel="noopener" href="https://github.com/Cysharp/ZString">ZString - Zero Allocation StringBuilder for .NET Core and Unity.</a>。</p>
<p>ZString主要是它自己重新定義自己的string型別，然後把原先.net內建的StringBuilder class改成struct結構，最後還自己管理一個inner buffer(allocated from ArrayPool)使得多數資源可以重複回收利用。當然你最後還是會有<code>ToString()</code>流程來取得最後的<code>string</code>才能把它當成原本的<code>string</code>使用，不過它可以大幅減少內部運算複製來複製去的GC.Alloc開銷。總之是一個很強的lib，細節可以去看<a target="_blank" rel="noopener" href="https://neuecc.medium.com/zstring-zero-allocation-stringbuilder-for-net-core-and-unity-f3163c88c887">作者這篇文</a>。</p>
<h2 id="3-yield"><a class="markdownIt-Anchor" href="#3-yield"></a> 3. yield</h2>
<p><code>yield</code>是<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-tw/dotnet/csharp/language-reference/keywords/yield">C#的一個語法糖</a>，要使用此關鍵字你必須寫在一個<code>IEnumerator</code>或<code>IEnumerable</code>的方法內，譬如以下例子。</p>
<blockquote>
<p>想要了解<code>yield</code>與<code>IEnumerator</code>的原理的建議去google一下，這邊不會花太多的篇幅解釋。</p>
</blockquote>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Process</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    Profiler<span class="token punctuation">.</span><span class="token function">BeginSample</span><span class="token punctuation">(</span><span class="token string">"SimpleEnumerator"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IEnumerator</span> simpleEnumerator <span class="token operator">=</span> <span class="token function">SimpleEnumerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// GC.Alloc</span>
    Profiler<span class="token punctuation">.</span><span class="token function">EndSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token return-type class-name">IEnumerator</span> <span class="token function">SimpleEnumerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">yield</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用<code>yield</code>會使compiler把這個方法包裝成一個實作IEnumerator的class，而這個class會在第一次<code>MoveNext()</code>後取得null的值便迭代結束(return false)，我們假設這個內部class命名為<code>SimpleEnumertor_Class</code>。之後這個<code>SimpleEnumertor()</code>會被改成類似下面這樣:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">private</span> <span class="token return-type class-name">IEnumerator</span> <span class="token function">SimpleEnumerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SimpleEnumerator_Class</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>發現了嗎? 他會new一個class出來，這就是導致當我們呼叫<code>SimpleEnumerator()</code>的時候會有GC.Alloc的原因。</p>
<blockquote>
<p>你可能會想那為什麼compiler要把它做成class而不是struct呢？</p>
<p>換個方向想，假設它會自動被做成struct然後return，注意你的回傳型別仍然是<code>IEnumerator</code>，這代表它會發生boxing，那始終還是會有GC.Alloc。</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/34757759/why-is-the-compiler-generated-enumerator-for-yield-not-a-struct">Stackoverflow相關討論</a></p>
</blockquote>
<h3 id="solution-3"><a class="markdownIt-Anchor" href="#solution-3"></a> Solution</h3>
<p>說真的我直到現在都對這個情況沒有一個好的解法，只要你想使用這個語法糖就必然要承受這個負擔。因為這個自動包裝好的<code>IEnumerator</code><strong>甚至沒有實作<code>Reset()</code>方法</strong>，所以連想要重複利用都沒辦法。總而言之只能注意不要在重複呼叫的程式碼區塊中使用到它吧。</p>
<p>真要解決的話就不能使用<code>yield</code>語法糖來製作<code>IEnumerator</code>物件，而是要自己定義一個實作<code>IEnumerator</code>的struct然後想辦法重現一樣的運行邏輯，但這樣寫起來就完全失去語法糖提供的便利性了。</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">SimpleEnumerator_Struct</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IEnumerator</span></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...implementation</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>不過這裡有個特定情形的優化方法，假設你有一個長這樣的class關係:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ClassBase</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token return-type class-name">IEnumerator</span> <span class="token function">SimpleEnumerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClassA</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ClassBase</span></span> <span class="token punctuation">&#123;</span> 
    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name">IEnumerator</span> <span class="token function">SimpleEnumerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//...</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>ClassA</code>必須實作這個<code>SimpleEnumerator()</code>方法，但你希望它甚麼都不做，這時候你可能會這樣寫:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name">IEnumerator</span> <span class="token function">SimpleEnumerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">yield</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>或</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name">IEnumerator</span> <span class="token function">SimpleEnumerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">yield</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>但這兩種寫法都還是會在呼叫時造成GC.Alloc，所以你其實可以這樣寫:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name">IEnumerator</span> <span class="token function">SimpleEnumerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>這樣就不會造成任何GC.Alloc了，因為你沒有使用<code>yield</code>語法糖所以它就只是一個會回傳null的普通方法。</p>
<blockquote>
<p>前兩種寫法你拿到的回傳值仍是一個實體的<code>IEnumerator</code>物件，第三種回傳值是真的null，回傳後的處理要注意這點。</p>
</blockquote>
<h2 id="4-startcoroutine"><a class="markdownIt-Anchor" href="#4-startcoroutine"></a> 4. StartCoroutine()</h2>
<p>前一個提到<code>IEnumerator</code>，它主要在Unity中就是給Coroutine使用的。不過我想已經網路上有很多文章提及過<code>StartCoroutine(DoSomething())</code>會有GC.Alloc所以要注意使用，這邊我要強調一下之所以會造成GC.Alloc是有兩個因素:</p>
<ol>
<li>上面提到的<code>yield</code>語法糖所做的new classobject()開銷</li>
<li><code>StartCoroutine</code>內部會new一個<code>Coroutine</code>物件並回傳出來，可參考<a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/Coroutine.html">官方doc</a></li>
</ol>
<h3 id="solution-4"><a class="markdownIt-Anchor" href="#solution-4"></a> Solution</h3>
<p>第一點請參考上面一個案例，第二點無解。所以還是一樣，能少用就少用。</p>
<p>另一個改善方案是改用同是CySharp大神寫的library: <a target="_blank" rel="noopener" href="https://github.com/Cysharp/UniTask">UniTask</a>, which provides an efficient allocation free async/await integration for Unity.</p>
<p>不過換成UniTask的寫法與原理完全不同，它是使用C#7.0的新功能<a target="_blank" rel="noopener" href="https://github.com/dotnet/roslyn/blob/main/docs/features/task-types.md">Async Task Types in C#</a>來實作的，更換過去需要適應一段時間。我目前看下來UniTask要全面汰換Coroutine應該完全沒問題，甚至能做出來的效果也遠比Coroutine多很多。</p>
<p>作者花了不少功夫在Zero Allocation:</p>
<ul>
<li>透過以struct實作的<code>UniTask</code>來取代內建的<code>Task</code> class</li>
<li>透過以struct實作的<code>AsyncMethodBuilder</code>來取代內建的Builder</li>
<li>Task Pool可以重複回收利用</li>
<li>Compiler內部自動生成的<code>AsyncStateMachine</code>在debug(developement) mode下會是class，在release mode下會優化成struct(所以在unity profiling要注意這點，詳情可見<a target="_blank" rel="noopener" href="https://github.com/Cysharp/UniTask#allocation-on-profiler">這裡</a>)</li>
</ul>
<p>其他細節可以看看<a target="_blank" rel="noopener" href="https://neuecc.medium.com/unitask-v2-zero-allocation-async-await-for-unity-with-asynchronous-linq-1aa9c96aa7dd">作者的文</a></p>
<p>這裡放個比較範例:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// I'll run this method 1000 times.</span>
<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Process</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    Profiler<span class="token punctuation">.</span><span class="token function">BeginSample</span><span class="token punctuation">(</span><span class="token string">"StartCoroutine"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    coroutineProxy<span class="token punctuation">.</span><span class="token function">StartCoroutine</span><span class="token punctuation">(</span><span class="token function">Coroutine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Profiler<span class="token punctuation">.</span><span class="token function">EndSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Profiler<span class="token punctuation">.</span><span class="token function">BeginSample</span><span class="token punctuation">(</span><span class="token string">"TaskAsync().Forget()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TaskAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Forget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Profiler<span class="token punctuation">.</span><span class="token function">EndSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token return-type class-name">IEnumerator</span> <span class="token function">Coroutine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">yield</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name">UniTaskVoid</span> <span class="token function">TaskAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">await</span> UniTask<span class="token punctuation">.</span><span class="token function">Yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在unity2020 editor改成release mode後查看profiler:<br />
<img src="https://i.imgur.com/cfEUXdD.png" alt="" /></p>
<p><em>這裡有提前多跑幾次後才profiling，因為pooling的特性需要多次使用才能顯現</em></p>
<h2 id="5-yieldinstruction系列的class"><a class="markdownIt-Anchor" href="#5-yieldinstruction系列的class"></a> 5. YieldInstruction系列的class</h2>
<p>這裡指的是<code>WaitForSeconds</code>, <code>WaitForSecondsRealtime</code>, <code>WaitForEndOfFrame</code>, <code>WaitForFixedUpdate</code>這些會用在Coroutine內部的類別。很多文章大概都講過這部分就是要cache它們重複使用，避免直接在內部new一個出來。我同意這個說法，但其實針對各個不同的類別有不同的改善方法。</p>
<h3 id="waitforseconds"><a class="markdownIt-Anchor" href="#waitforseconds"></a> WaitForSeconds</h3>
<p>直接看案例5.a</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// Case 5.a</span>
<span class="token function">StartCoroutine</span><span class="token punctuation">(</span><span class="token function">DelayWaitForSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token return-type class-name">IEnumerator</span> <span class="token function">DelayWaitForSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">yield</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WaitForSeconds</span><span class="token punctuation">(</span><span class="token number">1f</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// GC.Alloc</span>
    <span class="token comment">// Do something..</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>這個案例的確可以事前存好<code>WaitForSeconds</code>物件然後重複使用，像這樣:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// Case 5.a</span>
<span class="token class-name">WaitForSeconds</span> wait1sec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WaitForSeconds</span><span class="token punctuation">(</span><span class="token number">1f</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// cached.</span>
<span class="token function">StartCoroutine</span><span class="token punctuation">(</span><span class="token function">DelayWaitForSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token return-type class-name">IEnumerator</span> <span class="token function">DelayWaitForSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">yield</span> <span class="token keyword">return</span> wait1sec<span class="token punctuation">;</span> <span class="token comment">// free</span>
    <span class="token comment">// Do something..</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>但這種改善法有個問題，如果秒數本身是傳入參數要怎麼處理，如案例5.b</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// Case 5.b</span>
<span class="token function">StartCoroutine</span><span class="token punctuation">(</span><span class="token function">DelayWaitForSeconds</span><span class="token punctuation">(</span><span class="token number">1f</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token return-type class-name">IEnumerator</span> <span class="token function">DelayWaitForSeconds</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">float</span></span> seconds<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">yield</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WaitForSeconds</span><span class="token punctuation">(</span>seconds<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// GC.Alloc</span>
    <span class="token comment">// Do something..</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因為<code>WaitForSeconds</code>並不能在constructor以外的地方修改等待的秒數，上面的方法就很難用了。</p>
<p>所以比起用cache法，我更推薦以下這樣改善:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// Case 5.b</span>
<span class="token function">StartCoroutine</span><span class="token punctuation">(</span><span class="token function">DelayWaitForSeconds</span><span class="token punctuation">(</span><span class="token number">1f</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token return-type class-name">IEnumerator</span> <span class="token function">DelayWaitForSeconds</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">float</span></span> seconds<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">float</span></span> time <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> time <span class="token operator">&lt;</span> seconds<span class="token punctuation">;</span> time <span class="token operator">+=</span> Time<span class="token punctuation">.</span>deltaTime<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">yield</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// free.</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// Do something..</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>這樣的好處是:</p>
<ul>
<li>更改方便快速，你不用在method scope外增加任何東西。</li>
<li>萬一之後需要progress動畫之類的東西就可以直接在while裡面處理</li>
<li>在<a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/ExecutionOrder.html">Unity order of execution</a>中，yield null和yield WaitForSeconds的位置在同一區，多數時候不會發生改變執行順序產生的問題。</li>
<li>若傳入參數<code>seconds</code>是非正數，那它根本不會進去for迴圈也不會多等一個frame，反觀用<code>WaitForSecond</code>就必然要等至少一個frame。</li>
</ul>
<p>缺點是有些人可能看不懂這在寫什麼，可讀性較低一點。但我自己覺得只要團隊有介紹過這種寫法就不會有看不懂的問題。</p>
<h3 id="waitforsecondsrealtime"><a class="markdownIt-Anchor" href="#waitforsecondsrealtime"></a> WaitForSecondsRealtime</h3>
<p>這個與<code>WaitForSeconds</code>性質一樣，把<code>Time.deltaTime</code>換成<code>Time.unscaledDeltaTime</code>就可以了。</p>
<h3 id="waitforendofframe-waitforfixedupdate"><a class="markdownIt-Anchor" href="#waitforendofframe-waitforfixedupdate"></a> WaitForEndOfFrame &amp; WaitForFixedUpdate</h3>
<p>這兩個的性質一樣，就是要等到下一個執行迴圈的指定時間點繼續，看以下案例5.c</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// Case 5.c</span>
<span class="token function">StartCoroutine</span><span class="token punctuation">(</span><span class="token function">DelayToDoSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token return-type class-name">IEnumerator</span> <span class="token function">DelayToDoSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// wait for 3 end of frames</span>
    <span class="token keyword">yield</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WaitForEndOfFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// GC.Alloc</span>
    <span class="token keyword">yield</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WaitForEndOfFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// GC.Alloc</span>
    <span class="token keyword">yield</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WaitForEndOfFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// GC.Alloc</span>
    <span class="token comment">// Do something..</span>
    
    <span class="token comment">// wait for 3 fixed updates.</span>
    <span class="token keyword">yield</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WaitForFixedUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// GC.Alloc</span>
    <span class="token keyword">yield</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WaitForFixedUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// GC.Alloc</span>
    <span class="token keyword">yield</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WaitForFixedUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// GC.Alloc</span>
    <span class="token comment">// Do something..</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其實這兩個類別的實體毫無意義，內部實作是類似於</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">WaitForFixedUpdate</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>來判定的。所以說我們根本不需要每次使用都new一個實體使用，最方便的方式是開一個static shared variable供所有人使用就好了。</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// Case 5.c</span>
<span class="token function">StartCoroutine</span><span class="token punctuation">(</span><span class="token function">DelayToDoSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token return-type class-name">IEnumerator</span> <span class="token function">DelayToDoSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// wait for 3 end of frames</span>
    <span class="token keyword">yield</span> <span class="token keyword">return</span> WaitForInstances<span class="token punctuation">.</span>WaitForEndOfFrame<span class="token punctuation">;</span> <span class="token comment">// Free</span>
    <span class="token keyword">yield</span> <span class="token keyword">return</span> WaitForInstances<span class="token punctuation">.</span>WaitForEndOfFrame<span class="token punctuation">;</span> <span class="token comment">// Free</span>
    <span class="token keyword">yield</span> <span class="token keyword">return</span> WaitForInstances<span class="token punctuation">.</span>WaitForEndOfFrame<span class="token punctuation">;</span> <span class="token comment">// Free</span>
    <span class="token comment">// Do something..</span>
    
    <span class="token comment">// wait for 3 fixed updates.</span>
    <span class="token keyword">yield</span> <span class="token keyword">return</span> WaitForInstances<span class="token punctuation">.</span>WaitForFixedUpdate<span class="token punctuation">;</span> <span class="token comment">// Free</span>
    <span class="token keyword">yield</span> <span class="token keyword">return</span> WaitForInstances<span class="token punctuation">.</span>WaitForFixedUpdate<span class="token punctuation">;</span> <span class="token comment">// Free</span>
    <span class="token keyword">yield</span> <span class="token keyword">return</span> WaitForInstances<span class="token punctuation">.</span>WaitForFixedUpdate<span class="token punctuation">;</span> <span class="token comment">// Free</span>
    <span class="token comment">// Do something..</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">WaitForInstances</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">WaitForFixedUpdate</span> WaitForFixedUpdate <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WaitForFixedUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">WaitForEndOfFrame</span> WaitForEndOfFrame <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WaitForEndOfFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="waituntil-waitwhile"><a class="markdownIt-Anchor" href="#waituntil-waitwhile"></a> WaitUntil &amp; WaitWhile</h3>
<p>這兩個完全沒有理由要去使用，只要你知道<code>yield return null</code>的用法基本上就不需要這兩個類別了。</p>
<p>而且它們兩個還需要傳入<code>Func&lt;bool&gt;</code>，一般會用到Lambda expression，反而造成更多GC.Alloc。</p>
<h3 id="profiling"><a class="markdownIt-Anchor" href="#profiling"></a> Profiling</h3>
<p><img src="https://i.imgur.com/fwjzPmY.png" alt="" /></p>
<p>字尾加Fix的是修正後的結果</p>
<h2 id="6-delegate-lambda-expression-delegate-operator-anonymous-function"><a class="markdownIt-Anchor" href="#6-delegate-lambda-expression-delegate-operator-anonymous-function"></a> 6. Delegate (Lambda expression / delegate operator / anonymous function)</h2>
<p>名詞解釋就省略了，總之就是如下的範例:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Process</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    Profiler<span class="token punctuation">.</span><span class="token function">BeginSample</span><span class="token punctuation">(</span><span class="token string">"delegate implicit operator"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ActionParameter</span><span class="token punctuation">(</span>DoSomething<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 6.a</span>
    Profiler<span class="token punctuation">.</span><span class="token function">EndSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Profiler<span class="token punctuation">.</span><span class="token function">BeginSample</span><span class="token punctuation">(</span><span class="token string">"delegate explicit operator"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ActionParameter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>Action<span class="token punctuation">)</span>DoSomething<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 6.b</span>
    Profiler<span class="token punctuation">.</span><span class="token function">EndSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Profiler<span class="token punctuation">.</span><span class="token function">BeginSample</span><span class="token punctuation">(</span><span class="token string">"Lambda Experssion"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ActionParameter</span><span class="token punctuation">(</span> <span class="token comment">// 6.c</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
            <span class="token function">DoSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Profiler<span class="token punctuation">.</span><span class="token function">EndSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Profiler<span class="token punctuation">.</span><span class="token function">BeginSample</span><span class="token punctuation">(</span><span class="token string">"delegate operator"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ActionParameter</span><span class="token punctuation">(</span><span class="token keyword">delegate</span> <span class="token punctuation">&#123;</span> <span class="token function">DoSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 6.d</span>
    Profiler<span class="token punctuation">.</span><span class="token function">EndSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ActionParameter</span><span class="token punctuation">(</span><span class="token class-name">System<span class="token punctuation">.</span>Action</span> action<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    action<span class="token punctuation">?.</span><span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>以上abcd四種寫法都會有GC.Alloc，畢竟他就是無法避免地需要建立一個delegate物件出來。</p>
<blockquote>
<p>有些人可能會有個誤解 ─ 以為直接把一個方法當作delegate不會有GC.Alloc(第一種寫法)，因為你可能會覺得方法本身是唯一的、是一個常數，那我拿到這個唯一的方法的delegate不就是allocation free嗎?<br />
當然不是。</p>
<p>我們必須要有這個認知 ─ delegate也是object，delegate本身是可以重組合併其他delegate的(<code>operator+=</code> 和 <code>operator-=</code>)，所以它當然不是唯一的常數。</p>
</blockquote>
<h3 id="solution-5"><a class="markdownIt-Anchor" href="#solution-5"></a> Solution</h3>
<p>Lambda匿名函式寫法可能會跟外部的captured variable有關聯所以我沒辦法提供通用解法，不過你如果只是像範例1和2的寫法，我一般來說會cache起來優化:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token class-name">System<span class="token punctuation">.</span>Action</span> m_ActionDoSomething<span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_ActionDoSomething <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        m_ActionDoSomething <span class="token operator">=</span> DoSomething<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    Profiler<span class="token punctuation">.</span><span class="token function">BeginSample</span><span class="token punctuation">(</span><span class="token string">"Cached Action (Fix)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ActionParameter</span><span class="token punctuation">(</span>m_ActionDoSomething<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Profiler<span class="token punctuation">.</span><span class="token function">EndSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>當然免不了第一次使用時還是會有GC.Alloc，但至少可以重複利用。</p>
<p>缺點是你要開很多<code>System.Action</code>成員在類別內，可能會造成撰寫便利性和可讀性降低。</p>
<p>附上profiler:</p>
<p><img src="https://i.imgur.com/abyczvK.png" alt="" /></p>
<h2 id="7-captured-variable-陷阱"><a class="markdownIt-Anchor" href="#7-captured-variable-陷阱"></a> 7. Captured Variable 陷阱</h2>
<p>使用lambda匿名函式時有時候會用到<code>captured variable</code>的C#語言特性，簡單來說就是當你的匿名函式內部有使用到外面的變數時，compiler會自動幫你把指定的變數的reference儲存起來放入匿名函數內，且因為他是儲存reference，所以有時候會有不直覺的結果，可以參考案例: <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/271440/captured-variable-in-a-loop-in-c-sharp">Captured variable in a loop in C#</a>。</p>
<p>但我這篇不是要講邏輯上的陷阱，而是GC.Alloc的陷阱，直接看範例:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CapturedVariable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name"><span class="token keyword">int</span></span> var1 <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token function">ActionParameter</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
            <span class="token class-name"><span class="token keyword">int</span></span> var2 <span class="token operator">=</span> var1<span class="token punctuation">;</span> <span class="token comment">// &lt;--- captured variable.</span>
            <span class="token function">DoSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>這單純是一個簡單的captured variable使用例子，沒甚麼問題，但是我使用上有時候會有下面這種情況:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token function">CapturedVariablePitfall</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// GC.Alloc!</span>

<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CapturedVariablePitfall</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">bool</span></span> condition<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name"><span class="token keyword">int</span></span> var1 <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span> <span class="token comment">// GC.Alloc at this line for captured variable below.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>condition<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Even if condition==false, there is still GC.Alloc</span>
        <span class="token function">ActionParameter</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
                <span class="token class-name"><span class="token keyword">int</span></span> var2 <span class="token operator">=</span> var1<span class="token punctuation">;</span> <span class="token comment">// &lt;--- because of this captured variable.</span>
                <span class="token function">DoSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>上面這種寫法會有GC.Alloc！</strong><br />
<strong>上面這種寫法會有GC.Alloc！</strong><br />
<strong>上面這種寫法會有GC.Alloc！</strong><br />
很不直覺的一個坑，第一次遇到的時候花了好一陣子才搞懂。</p>
<p>這段code的<code>CapturedVariablePitfall</code>方法本身是<strong>根據傳入參數來決定是否執行ActionParameter()</strong>，而我第一行使用會傳入<code>false</code>，直覺上code根本不會進到<code>if</code>內部所以也根本不會建立匿名函數，那怎麼會有GC.Alloc?</p>
<p>以結果來說，在方法的第一行就會產生GC.Alloc了，這點你可以用Profiler抓抓看就能驗證。至於為什麼，要看看Compiler到底編譯了甚麼東西出來才清楚，我直接用SharpLab這個網站來看看<a target="_blank" rel="noopener" href="https://sharplab.io/#v2:EYLgHgbALANAJiA1AHwAICYAMBYAUBgRjz1QGYACDcgMQHlbyBvPc111KcgYQEMAHAC4BXAE4BTOADUeIgJY9gAGzEAKAJRMWbbbIB2A8gDcZBcgF5yBTJgDc5APT3yAcS4A6AIKLFAewDG5DwGAgAWsgDO5Ip6YuQAZj4i5H78wuJwRjLySrHAYr4A7m5a2uwE6AAKMjwAtmICYiIqJaXq5gB8mrilPeR6BsYi6OaZIgR2juQAPAC0c+R5KULhsT5x5KERyamiEqPZysXdvQC+ajYtJy0tHOQAcj68grtSWQrKbczHPf2jphZWWwOJyuTzefyBYJhSLRXSxBJJFLPdL7d65fI+IotbSocpVES1eqNZrfVoaMydL69UrYthnC6kq6km6cJ5pCTSORoiqyARxHjeFTAHw+RTJHy6OC82QSjRU3q/Qb/SzWCYg9xeXwBIIbaFRGLxRLbZF7QYHdGFI7U2TrFR+CVSgQy3Ry4HkACihjEuj663tkulErMZn5ihWMF1jViW3CTu8Lg14L8tJ6uMq1TqDSaKep5DaFK6uaLfX0o2GFiVaumcxmCzESxW5DWuq2SPZGTNaKtxe09JzTN711wLMoeIzRKauLcacCfidssLvR4c+dbgAkrpDD4ANaqc6XPAnIA==">編譯結果</a>:</p>
<p>C#原始碼編譯前:<br />
<img src="https://i.imgur.com/VblsShi.png" alt="" /></p>
<p>因為IL語言比較難看懂，這邊直接看編譯後的C#表示法就行了，編譯後C#:<br />
<img src="https://i.imgur.com/IBIn6oo.png" alt="" /></p>
<p>有對照組很明顯看得出問題點吧，Captured Variable實際上是在那個變數宣告的地方就馬上capture成一個object了，這也就是為什麼會有GC.Alloc。</p>
<h3 id="solution-6"><a class="markdownIt-Anchor" href="#solution-6"></a> Solution</h3>
<p>理解GC.Alloc的原因後要修正就很簡單了，因為原本那個變數可能有其他人要使用，一般來說沒辦法直接移到if內部，所以多數情況都是在if內部再創一個變數使用即可。</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CapturedVariablePitfallFix</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">bool</span></span> condition<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name"><span class="token keyword">int</span></span> var1 <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>condition<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">int</span></span> var1Copy <span class="token operator">=</span> var1<span class="token punctuation">;</span> <span class="token comment">// GC.Alloc at this line for captured variable below.</span>
        <span class="token function">ActionParameter</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
                <span class="token class-name"><span class="token keyword">int</span></span> var2 <span class="token operator">=</span> var1Copy<span class="token punctuation">;</span> <span class="token comment">// &lt;--- captured variable.</span>
                <span class="token function">DoSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>打開Profiler驗證一下:</p>
<p><img src="https://i.imgur.com/AlYuR6u.png" alt="" /></p>
<h2 id="8-local-arrayliststackqueuehashsetdictionary"><a class="markdownIt-Anchor" href="#8-local-arrayliststackqueuehashsetdictionary"></a> 8. Local array/list/stack/queue/hashset/dictionary</h2>
<p>有時候會需要在一個方法內部創建一個暫時的容器使用，如以下程式碼:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">TemporaryArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name"><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> numbers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">int</span></span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numbers<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        numbers<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// do something with numbers array.</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>建立容器避免不了GC.Alloc，不過你可以用Pooling解決這件事。這時候我會推薦導入一些unity沒有使用到的.net內建dll檔，你可以從<a target="_blank" rel="noopener" href="https://github.com/Cysharp/ZString/tree/master/src/ZString.Unity/Assets/Plugins">ZString的專案找到它們</a>，這樣你就可以使用<code>System.Buffers.ArrayPool</code>這個類別，改成以下這樣:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"> <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">TemporaryArrayFix1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name"><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> numbers <span class="token operator">=</span> System<span class="token punctuation">.</span>Buffers<span class="token punctuation">.</span>ArrayPool<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token punctuation">.</span>Shared<span class="token punctuation">.</span><span class="token function">Rent</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Rent an array from shared pool.</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numbers<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        numbers<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    System<span class="token punctuation">.</span>Buffers<span class="token punctuation">.</span>ArrayPool<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token punctuation">.</span>Shared<span class="token punctuation">.</span><span class="token function">Return</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Return an array to the pool.</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>一般來說這些dll應該可以正常使用(至少有ZString背書)，不過如果還是有專案沒辦法導入這些dll的話，你也可以自己寫一個<code>ArrayPool</code>。</p>
</blockquote>
<p>除了Array以外的容器你也希望pooling的話你就得自己寫個類別來用，以下是一個未經驗證優化的簡單實作:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ListPool<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ListPool<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> Shared <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ListPool<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Stack<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span><span class="token punctuation">></span></span> m_Inactived <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Stack<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token function">Rent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>m_Inactived<span class="token punctuation">.</span>Count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">List<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> pop <span class="token operator">=</span> m_Inactived<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pop <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> pop<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Return</span><span class="token punctuation">(</span><span class="token class-name">List<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
        list<span class="token punctuation">.</span><span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        m_Inactived<span class="token punctuation">.</span><span class="token function">Push</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Expand capacity規則什麼的還有優化空間，不過上面這樣就能解決GC.Alloc問題了，其他容器pool也依樣畫葫蘆。</p>
<p>另外暫用的小型Array我個人會更喜歡下面這種寫法，這也需要仰賴上面提到的dll檔:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">TemporaryArrayFix2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">System<span class="token punctuation">.</span>Span<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">></span></span> numbers <span class="token operator">=</span> <span class="token keyword">stackalloc</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numbers<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        numbers<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>System.Span</code>是C# 7.2的新類別，可以用來表示一個記憶體區塊。</p>
<p><code>stackalloc</code> 是C# 8.0的新功能，可以在stack建立一個連續的記憶體區塊，其實就相當於一堆local variables，所以他會在方法return時自動捨棄掉。</p>
<p>這才是名符其實的Zero Allocation寫法，這是我在讀ZString原始碼的時候學到的，非常實用。</p>
<p>缺點是Stack記憶體有限制大小，超出範圍會throw StackOverflowException要注意。還有它不支援不確定實際長度的Managed class，所以基本上幾乎所有class都不能用。</p>
<p>延伸閱讀: <a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-tw/dotnet/api/system.span-1?view=net-6.0">Span<T> 結構</a>、<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-tw/dotnet/csharp/language-reference/operators/stackalloc">stackalloc 運算式 (c # 參考)</a></p>
<h2 id="9-boxing"><a class="markdownIt-Anchor" href="#9-boxing"></a> 9. Boxing</h2>
<p>Boxing的定義和原理網路上很多資料查一下就有，這邊只討論發生的時機點和如何避免。</p>
<p>boxing會在一個Value Type物件被轉型成Reference Type時發生，具體來說的boxing是會發生在:</p>
<ul>
<li>Value Type物件被轉型成<code>object</code></li>
<li>Value Type物件被轉型成interface</li>
<li>struct物件被轉型成<code>System.ValueType</code>(這是一個內部的abstract class)</li>
</ul>
<p>範例程式碼:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Process</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">KindOfStruct</span> kindOfStructA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">KindOfStruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">KindOfStruct</span> kindOfStructB <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">KindOfStruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    Profiler<span class="token punctuation">.</span><span class="token function">BeginSample</span><span class="token punctuation">(</span><span class="token string">"Object boxing: Parameter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ObjectParameter</span><span class="token punctuation">(</span>kindOfStructA<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// boxing: KindOfStruct -> object</span>
    Profiler<span class="token punctuation">.</span><span class="token function">EndSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Profiler<span class="token punctuation">.</span><span class="token function">BeginSample</span><span class="token punctuation">(</span><span class="token string">"Object boxing: Equals"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    kindOfStructA<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>kindOfStructB<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// double boxing: KindOfStruct -> System.ValueType and KindOfStruct -> object</span>
    Profiler<span class="token punctuation">.</span><span class="token function">EndSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Profiler<span class="token punctuation">.</span><span class="token function">BeginSample</span><span class="token punctuation">(</span><span class="token string">"Object boxing: GetHashCode"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    kindOfStructA<span class="token punctuation">.</span><span class="token function">GetHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// boxing: KindOfStruct -> System.ValueType</span>
    Profiler<span class="token punctuation">.</span><span class="token function">EndSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Profiler<span class="token punctuation">.</span><span class="token function">BeginSample</span><span class="token punctuation">(</span><span class="token string">"Interface boxing: Parameter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">InterfaceParameter</span><span class="token punctuation">(</span>kindOfStructA<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// boxing: KindOfStruct -> IKindOfInterface</span>
    Profiler<span class="token punctuation">.</span><span class="token function">EndSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ObjectParameter</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> obj<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">InterfaceParameter</span><span class="token punctuation">(</span><span class="token class-name">IKindOfInterface</span> kindOfInterface<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    kindOfInterface<span class="token punctuation">.</span><span class="token function">DoSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token keyword">interface</span> <span class="token class-name">IKindOfInterface</span> <span class="token punctuation">&#123;</span>
    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">DoSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token keyword">struct</span> <span class="token class-name">KindOfStruct</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IKindOfInterface</span></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">int</span></span> <span class="token keyword">value</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">DoSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>以上是很常見會發生boxing的方式。</p>
<h3 id="solution-7"><a class="markdownIt-Anchor" href="#solution-7"></a> Solution</h3>
<p>傳入參數轉型成<code>object</code>/interface這種情境相關的問題就沒辦法，不過<code>Equals</code>和<code>GetHashCode</code>這兩個boxing是可以完全解決的，只要你乖乖地在struct內實作這些方法就行了:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token class-name">KindOfStructFix</span> kindOfStructFixA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">KindOfStructFix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">KindOfStructFix</span> kindOfStructFixB <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">KindOfStructFix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Profiler<span class="token punctuation">.</span><span class="token function">BeginSample</span><span class="token punctuation">(</span><span class="token string">"Object boxing: Equals (Fix)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
kindOfStructFixA<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>kindOfStructFixB<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// No boxing as it's implemented method.</span>
Profiler<span class="token punctuation">.</span><span class="token function">EndSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Profiler<span class="token punctuation">.</span><span class="token function">BeginSample</span><span class="token punctuation">(</span><span class="token string">"Object boxing: GetHashCode (Fix)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
kindOfStructFixA<span class="token punctuation">.</span><span class="token function">GetHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// No boxing as it's implemented method.</span>
Profiler<span class="token punctuation">.</span><span class="token function">EndSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">private</span> <span class="token keyword">struct</span> <span class="token class-name">KindOfStructFix</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IKindOfInterface</span><span class="token punctuation">,</span> <span class="token class-name">System<span class="token punctuation">.</span>IEquatable<span class="token punctuation">&lt;</span>KindOfStructFix<span class="token punctuation">></span></span></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">int</span></span> <span class="token keyword">value</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">DoSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">Equals</span><span class="token punctuation">(</span><span class="token class-name">KindOfStructFix</span> other<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">value</span> <span class="token operator">==</span> other<span class="token punctuation">.</span><span class="token keyword">value</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">GetHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">value</span><span class="token punctuation">.</span><span class="token function">GetHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>正確地撰寫一個struct應該要實作哪些interface和方法，關於這個問題我之前的一篇文章 <a href="/2020/12/14/More-Effective-C-2nd-%E8%AE%80%E6%9B%B8%E7%AD%86%E8%A8%98/#%E4%BA%86%E8%A7%A3%E5%A4%9A%E7%A8%AE%E7%9B%B8%E7%AD%89%E6%A6%82%E5%BF%B5%E4%B9%8B%E9%96%93%E7%9A%84%E9%97%9C%E4%BF%82">More Effective C# 筆記 #1 資料型別</a> 有寫到相關內容。</p>
</blockquote>
<h2 id="10-params-array-as-method-paramters"><a class="markdownIt-Anchor" href="#10-params-array-as-method-paramters"></a> 10. <code>params</code> Array as method paramters</h2>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Process</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    Profiler<span class="token punctuation">.</span><span class="token function">BeginSample</span><span class="token punctuation">(</span><span class="token string">"params int[] as method paramters"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// GC.Alloc for int array.</span>
    <span class="token function">Max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4564</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// GC.Alloc for int array.</span>
    <span class="token function">Max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4564</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// GC.Alloc for int array.</span>
    Profiler<span class="token punctuation">.</span><span class="token function">EndSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">Max</span><span class="token punctuation">(</span><span class="token keyword">params</span> <span class="token class-name"><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> values<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// GC.Alloc for int array.</span>
    <span class="token class-name"><span class="token keyword">int</span></span> max <span class="token operator">=</span> values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> values<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>values<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">></span> max<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> 
            max <span class="token operator">=</span> values<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> max<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>這個蠻好懂的吧，雖然用了語法糖<code>params</code>但傳入的參數仍然會轉成<code>int[]</code>，既然是陣列那自然免不了GC.Alloc。</p>
<h3 id="solution-8"><a class="markdownIt-Anchor" href="#solution-8"></a> Solution</h3>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Process</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    Profiler<span class="token punctuation">.</span><span class="token function">BeginSample</span><span class="token punctuation">(</span><span class="token string">"overload method paramters"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MaxFix</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MaxFix</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4564</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MaxFix</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4564</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Profiler<span class="token punctuation">.</span><span class="token function">EndSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">MaxFix</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> v1<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> v2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> v1 <span class="token operator">></span> <span class="token class-name">v2 <span class="token punctuation">?</span></span> v1 <span class="token punctuation">:</span> v2<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">MaxFix</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> v1<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> v2<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> v3<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> v1 <span class="token operator">></span> v2 <span class="token punctuation">?</span> <span class="token punctuation">(</span>v1 <span class="token operator">></span> <span class="token class-name">v3 <span class="token punctuation">?</span></span> v1 <span class="token punctuation">:</span> v3<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>v2 <span class="token operator">></span> <span class="token class-name">v3 <span class="token punctuation">?</span></span> v2 <span class="token punctuation">:</span> v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">MaxFix</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> v1<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> v2<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> v3<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> v4<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> v1 <span class="token operator">></span> v2 <span class="token punctuation">?</span> 
        <span class="token punctuation">(</span>v1 <span class="token operator">></span> v3 <span class="token punctuation">?</span> <span class="token punctuation">(</span>v1 <span class="token operator">></span> <span class="token class-name">v4 <span class="token punctuation">?</span></span> v1 <span class="token punctuation">:</span> v4<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>v3 <span class="token operator">></span> <span class="token class-name">v4 <span class="token punctuation">?</span></span> v3 <span class="token punctuation">:</span> v4<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> 
        <span class="token punctuation">(</span>v2 <span class="token operator">></span> v3 <span class="token punctuation">?</span> <span class="token punctuation">(</span>v2 <span class="token operator">></span> <span class="token class-name">v4 <span class="token punctuation">?</span></span> v2 <span class="token punctuation">:</span> v4<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>v3 <span class="token operator">></span> <span class="token class-name">v4 <span class="token punctuation">?</span></span> v3 <span class="token punctuation">:</span> v4<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最直接的方法就是overload，寫起來麻煩但也沒辦法。</p>
<blockquote>
<p>其實這種overload方法很容易在別人寫的lib裡面看到，常見的會搭配Template使用。一般來說<code>params</code>版本的overload也會留著以防使用者真的不幸用超過了上限數量。</p>
</blockquote>
<h2 id="11-enumhasflag"><a class="markdownIt-Anchor" href="#11-enumhasflag"></a> 11. Enum.HasFlag()</h2>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">System<span class="token punctuation">.</span>Flags</span></span><span class="token punctuation">]</span>
<span class="token keyword">private</span> <span class="token keyword">enum</span> <span class="token class-name">AttackAttribute</span> <span class="token punctuation">&#123;</span>
    None <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    Poison <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">,</span>
    Burning <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">,</span>
    Death <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Attack1</span><span class="token punctuation">(</span><span class="token class-name">AttackAttribute</span> attackAttribute<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>attackAttribute<span class="token punctuation">.</span><span class="token function">HasFlag</span><span class="token punctuation">(</span>AttackAttribute<span class="token punctuation">.</span>Poison<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// poison.</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>attackAttribute<span class="token punctuation">.</span><span class="token function">HasFlag</span><span class="token punctuation">(</span>AttackAttribute<span class="token punctuation">.</span>Burning<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// burning.</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>attackAttribute<span class="token punctuation">.</span><span class="token function">HasFlag</span><span class="token punctuation">(</span>AttackAttribute<span class="token punctuation">.</span>Death<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// death.</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如上的寫法。由於<code>HasFlag</code>的定義是<code>System.Enum.HasFlag(System.Enum flag)</code>，理論上這樣呼叫會有兩個boxing ─ 一個是caller的一個是param的。<br />
<strong>但是!</strong><br />
<strong>但是!</strong><br />
<strong>但是!</strong><br />
你如果用Unity Profiler看，會發現它竟然沒有GC.Alloc！ (on Unity2019LTS and 2020LTS)<br />
<img src="https://i.imgur.com/2kJ1FDC.png" alt="" /></p>
<p>這個疑惑我拿去餵google也沒有找到一個明確的解答，我也用了SharpLab和dnSpy看編譯後的IL也都顯示會有boxing才對。<br />
所以只好不負責任地用猜的了:</p>
<blockquote>
<p>就是Compiler有針對這種情況優化，可能類似Array和List的foreach沒有GC.Alloc那樣的優化。<br />
另外有查到Mono 4.0 2015年有針對HasFlag方法優化快了60倍，猜測可能是unity有同步這次更新，<a target="_blank" rel="noopener" href="https://www.mono-project.com/docs/about-mono/releases/4.0.0/#fine-tuning">文章在這</a>。</p>
</blockquote>
<h3 id="所以enumhasflag可以放心使用了"><a class="markdownIt-Anchor" href="#所以enumhasflag可以放心使用了"></a> 所以<code>Enum.HasFlag()</code>可以放心使用了?</h3>
<p>不，這次看看以下的寫法:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"> <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Attack2</span><span class="token punctuation">(</span><span class="token class-name">AttackAttribute</span> attackAttribute<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HandleFlag</span><span class="token punctuation">(</span>attackAttribute<span class="token punctuation">,</span> AttackAttribute<span class="token punctuation">.</span>Poison<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// poison.</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HandleFlag</span><span class="token punctuation">(</span>attackAttribute<span class="token punctuation">,</span> AttackAttribute<span class="token punctuation">.</span>Burning<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// burning.</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HandleFlag</span><span class="token punctuation">(</span>attackAttribute<span class="token punctuation">,</span> AttackAttribute<span class="token punctuation">.</span>Death<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// death.</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">HandleFlag</span><span class="token punctuation">(</span><span class="token class-name">AttackAttribute</span> attackAttribute<span class="token punctuation">,</span> <span class="token class-name">AttackAttribute</span> flag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>attackAttribute<span class="token punctuation">.</span><span class="token function">HasFlag</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>這樣寫就冒出6次的GC.Alloc了: <img src="https://i.imgur.com/OqvAdxp.png" alt="" /><br />
也就是變回Compiler沒有優化了的情形。</p>
<p>總之就是，<strong>當<code>HasFlag</code>的輸入參數<code>flag</code>不是一個常數時，GC.Alloc就會出現了</strong>。</p>
<p>所以扯了一圈，我還是建議<strong>完全不要使用<code>HasFlag()</code>，改用位元運算子</strong>:</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Attack2Fix</span><span class="token punctuation">(</span><span class="token class-name">AttackAttribute</span> attackAttribute<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HandleFlagFix</span><span class="token punctuation">(</span>attackAttribute<span class="token punctuation">,</span> AttackAttribute<span class="token punctuation">.</span>Poison<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// poison.</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HandleFlagFix</span><span class="token punctuation">(</span>attackAttribute<span class="token punctuation">,</span> AttackAttribute<span class="token punctuation">.</span>Burning<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// burning.</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HandleFlagFix</span><span class="token punctuation">(</span>attackAttribute<span class="token punctuation">,</span> AttackAttribute<span class="token punctuation">.</span>Death<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// death.</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">HandleFlagFix</span><span class="token punctuation">(</span><span class="token class-name">AttackAttribute</span> attackAttribute<span class="token punctuation">,</span> <span class="token class-name">AttackAttribute</span> flag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>attackAttribute <span class="token operator">&amp;</span> flag<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>執行效率絕對比<code>HasFlag</code>高且絕對不會有GC.Alloc，唯一的缺點是可讀性比較差一點而已。</p>
<blockquote>
<p>如果有一個工程師跟我說他看不懂位元運算子，那我也沒什麼話好跟他說了。</p>
</blockquote>
<h2 id="12-unityapi-any-reference-type-as-return-value"><a class="markdownIt-Anchor" href="#12-unityapi-any-reference-type-as-return-value"></a> 12. UnityAPI: Any reference type as return value.</h2>
<p>其實不只unity API，照理來說任何安全的library提供的API在回傳reference type的東西的時候都會額外copy一份出來以免被使用者搞壞，這也導致了GC.Alloc發生。</p>
<p>並且要注意property getter基本上跟function return是一樣的行為，所以通常也都會做copy的動作。</p>
<p>一般來說UnityAPI都有提供Zero Allocation的API來代替，但還是有些功能就是沒提供，下面就直接列出來我自己常用到的一些APIs。</p>
<table>
<thead>
<tr>
<th>GC.Alloc</th>
<th>Zero Allocation</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>GameObject.tag == &quot;Player&quot;</code></td>
<td><code>GameObject.CompareTag(&quot;Player&quot;)</code></td>
</tr>
<tr>
<td><code>Physics2D.RaycastAll()</code> <em>and other CastAll methods</em></td>
<td><code>Physics2D.RaycastNonAlloc()</code> <em>and other CastNonAlloc and single Cast methods</em></td>
</tr>
<tr>
<td><code>Physics2D.OverlapCircleAll()</code> <em>and other OverlapAll methods</em></td>
<td><code>Physics2D.OverlapCircleNonAlloc()</code> <em>and other OverlapNonAlloc and single Overlap methods</em></td>
</tr>
<tr>
<td><code>Collision2D.contacts</code></td>
<td><code>Collision2D.GetContacts()</code> and <code>Collision2D.GetContact(i)</code></td>
</tr>
<tr>
<td><code>Renderer.sharedMaterials</code></td>
<td><code>Renderer.GetSharedMaterials</code>()</td>
</tr>
<tr>
<td><code>Mesh.vertices</code>, <code>Mesh.normals</code>, <code>Mesh.tangents</code>, <code>Mesh.uv</code>, <code>Mesh.colors</code>, <code>Mesh.triangles</code> and <code>Mesh.boneWeights</code></td>
<td><code>Mesh.GetVertices()</code>,<code>Mesh.GetNormals()</code>, <code>Mesh.GetTangents()</code>, <code>Mesh.GetUVs()</code>, <code>Mesh.GetColors()</code>, <code>Mesh.GetTriangles()</code> and <code>Mesh.GetBoneWeights()</code></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>一時之間想不到還有哪些常見的API，之後有想到會陸陸續續補上來。</p>
<h1 id="repository"><a class="markdownIt-Anchor" href="#repository"></a> Repository</h1>
<p>在撰寫這篇文時我也順便開了一個unity project來驗證，本篇文提及的所有原始碼和Profiler結果都包含在裡面。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/qwe321qwe321qwe321/Unity-Avoid-GC-Alloc-Cases">https://github.com/qwe321qwe321qwe321/Unity-Avoid-GC-Alloc-Cases</a></p>
<p>測試環境: Unity2020.3.31f1 Win10</p>
<h1 id="後話"><a class="markdownIt-Anchor" href="#後話"></a> 後話</h1>
<p>這篇文前前後後花了4天以上才寫完，比起初預想的時間還要久很多很多。主要是一些知識在撰寫的途中才發現自己好像還沒有十足的把握，才花了更多的時間去驗證它們。<br />
不過這樣也好，寫文章的目的一直以來都是為了自己:O</p>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2021/01/11/%E5%88%9D%E5%AD%B8%E9%81%8A%E6%88%B2%E7%89%A9%E7%90%86-%E7%B0%A1%E4%BB%8B/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>Prev</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime" title="Update time"></i>
              2022-04-14 07:24:00
            </span>
            
                  <span class="post-tags">
                    <i class="iconfont icon-tags" title="Tags"></i>
                    
                    <span class="span--tag">
                      <a href="/tags/Unity/" title="Unity">
                        <b>#</b> Unity
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/C/" title="C#">
                        <b>#</b> C#
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
              <a href="/2022/10/11/Embed-GlslEditor-in-Markdown/" target="_self">
                <span>Next</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">Contents</div>
    <div class="catalog-content">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text"> 前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#zero-allocation"><span class="toc-text"> Zero Allocation</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#why"><span class="toc-text"> Why?</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#when-is-heap-memory-allocated"><span class="toc-text"> When is heap memory allocated?</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#cases"><span class="toc-text"> Cases</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E8%83%BD%E7%94%A8struct%E5%B0%B1%E4%B8%8D%E8%A6%81%E7%94%A8class"><span class="toc-text"> 1. 能用struct就不要用class</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#solution"><span class="toc-text"> Solution</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-non-constant-string"><span class="toc-text"> 2. Non-constant string</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#solution-2"><span class="toc-text"> Solution</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-yield"><span class="toc-text"> 3. yield</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#solution-3"><span class="toc-text"> Solution</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-startcoroutine"><span class="toc-text"> 4. StartCoroutine()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#solution-4"><span class="toc-text"> Solution</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-yieldinstruction%E7%B3%BB%E5%88%97%E7%9A%84class"><span class="toc-text"> 5. YieldInstruction系列的class</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#waitforseconds"><span class="toc-text"> WaitForSeconds</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#waitforsecondsrealtime"><span class="toc-text"> WaitForSecondsRealtime</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#waitforendofframe-waitforfixedupdate"><span class="toc-text"> WaitForEndOfFrame &amp; WaitForFixedUpdate</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#waituntil-waitwhile"><span class="toc-text"> WaitUntil &amp; WaitWhile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#profiling"><span class="toc-text"> Profiling</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-delegate-lambda-expression-delegate-operator-anonymous-function"><span class="toc-text"> 6. Delegate (Lambda expression &#x2F; delegate operator &#x2F; anonymous function)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#solution-5"><span class="toc-text"> Solution</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-captured-variable-%E9%99%B7%E9%98%B1"><span class="toc-text"> 7. Captured Variable 陷阱</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#solution-6"><span class="toc-text"> Solution</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-local-arrayliststackqueuehashsetdictionary"><span class="toc-text"> 8. Local array&#x2F;list&#x2F;stack&#x2F;queue&#x2F;hashset&#x2F;dictionary</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-boxing"><span class="toc-text"> 9. Boxing</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#solution-7"><span class="toc-text"> Solution</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-params-array-as-method-paramters"><span class="toc-text"> 10. params Array as method paramters</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#solution-8"><span class="toc-text"> Solution</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-enumhasflag"><span class="toc-text"> 11. Enum.HasFlag()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%80%E4%BB%A5enumhasflag%E5%8F%AF%E4%BB%A5%E6%94%BE%E5%BF%83%E4%BD%BF%E7%94%A8%E4%BA%86"><span class="toc-text"> 所以Enum.HasFlag()可以放心使用了?</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-unityapi-any-reference-type-as-return-value"><span class="toc-text"> 12. UnityAPI: Any reference type as return value.</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#repository"><span class="toc-text"> Repository</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BE%8C%E8%A9%B1"><span class="toc-text"> 後話</span></a></li></ol>
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        


  <div id="disqus_thread"></div>
  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
  /*
  var disqus_config = function () {
  this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
  this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  };
  */
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://pedevmakesgame.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>






      </div>
    
  </div>
  
<!-- This part is only generated if the post have glsl=true property. -->
<link type="text/css" rel="stylesheet" href="/glsl/glslEditor.css">
<script type="application/javascript" src="/glsl/glslEditor.js"></script>
<script type="text/javascript">
    // parse EDITORS
	var ccList = document.querySelectorAll(".glslEditorCanvas");
	for(var i = 0; i < ccList.length; i++){
        let codeblock = ccList[i].querySelector("textarea");
        if (codeblock) {
            let code = codeblock.value;
            //console.log(code);
            ccList[i].removeChild(codeblock);
            var editor = new GlslEditor(ccList[i], {
                canvas_size: 250,
                canvas_follow: true,
                canvas_float: 'right',
                theme: 'monokai',
                tooltips: true,
                exportIcon: true,
            });
            editor.setContent(code);
        }
    }
</script>




        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          <a title="github" target="_blank" rel="noopener" href="https://github.com/qwe321qwe321qwe321">
            <i class="iconfont icon-github"></i>
          </a>
        </li>
      
        <li>
          <a title="twitter" target="_blank" rel="noopener" href="https://twitter.com/PeDev_">
            <i class="iconfont icon-twitter"></i>
          </a>
        </li>
      
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/qwe321qwe321qwe321">Copyright © 2023 PeDev</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a>
        
    </div>
  
</div>
<script src="/js/prism/prism.js" async></script>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="Search...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>First search, index file loading, please wait...<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>No result<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The search.xml file was not found, please refer to：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The request failed, Try to refresh the page or try again later.<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        
  
    <div class="share-icon tools-bar-item">
      <a href="javascript: void(0)" id="share-icon">
        <i class="iconfont iconshare"></i>
      </a>
      <div class="share-content hidden">
        
          <a class="share-item" href="https://twitter.com/intent/tweet?text=' + Unity%2FC%23.Net%20%E5%B8%B8%E7%94%A8%E7%9A%84%20Memory%20Allocation%20%E5%84%AA%E5%8C%96%E6%95%B4%E7%90%86 + '&url=' + https%3A%2F%2Fqwe321qwe321qwe321.github.io%2F2022%2F04%2F14%2FUnity-CSharp-DotNet-%25E5%25B8%25B8%25E7%2594%25A8%25E7%259A%2584Memory%2520Allocation%25E5%2584%25AA%25E5%258C%2596%25E6%2595%25B4%25E7%2590%2586%2F + '" target="_blank" title="Twitter">
            <i class="iconfont icon-twitter"></i>
          </a>
        
        
          <a class="share-item" href="https://www.facebook.com/sharer.php?u=https://qwe321qwe321qwe321.github.io/2022/04/14/Unity-CSharp-DotNet-%E5%B8%B8%E7%94%A8%E7%9A%84Memory%20Allocation%E5%84%AA%E5%8C%96%E6%95%B4%E7%90%86/" target="_blank" title="Facebook">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        
      </div>
    </div>
  
  
<script src="/js/shares.js"></script>



      </div>
    </div>
  </body>
</html>
